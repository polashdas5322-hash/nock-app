workflows:
  ios-app-preview:
    name: iOS App Preview
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: 16.2
    scripts:
      - name: Hard Reset and Build iOS Simulator
        script: |
          # 1. Clean Flutter
          flutter clean
          flutter pub get
          
          # 2. First pass: let Flutter set up everything (pod install, Dart compilation)
          # This will FAIL at link time due to unpatched FFmpeg â€” that's expected.
          echo "ðŸ”„ Pass 1: Setting up build environment..."
          flutter build ios --simulator --debug --no-codesign 2>&1 || true
          
          # 3. Patch ALL FFmpeg framework binaries for Simulator
          # Must happen AFTER Flutter's pod install to avoid being overwritten
          echo "ðŸ”§ Patching FFmpeg frameworks for simulator..."
          patch_frameworks() {
            local dir="$1"
            if [ -d "$dir" ]; then
              for fw in "$dir"/*.framework; do
                local binary_name=$(basename "$fw" .framework)
                local binary="$fw/$binary_name"
                if [ -f "$binary" ]; then
                  echo "  Patching: $binary_name"
                  xcrun vtool -arch arm64 -set-build-version 7 15.1 15.1 -replace "$binary" -output "$binary" 2>/dev/null || true
                fi
              done
            fi
          }
          # Patch in pub cache (source of truth)
          PUB_FW=$(ls -d $HOME/.pub-cache/hosted/pub.dev/ffmpeg_kit_flutter_new-*/ios/Frameworks 2>/dev/null | head -1)
          patch_frameworks "$PUB_FW"
          # Patch in Pods directory (what Xcode actually links against)
          PODS_FW=$(ls -d ios/Pods/ffmpeg_kit_flutter_new/ios/Frameworks 2>/dev/null | head -1)
          patch_frameworks "$PODS_FW"
          # Patch via symlinks path
          SYM_FW=$(ls -d ios/.symlinks/plugins/ffmpeg_kit_flutter_new/ios/Frameworks 2>/dev/null | head -1)
          patch_frameworks "$SYM_FW"
          echo "âœ… All FFmpeg frameworks patched"
          
          # 4. Clean Xcode build cache so pods recompile with patched frameworks
          echo "ðŸ§¹ Cleaning Xcode build cache..."
          rm -rf ios/build
          rm -rf $HOME/Library/Developer/Xcode/DerivedData/*Runner* 2>/dev/null || true
          
          # 5. Second pass: full rebuild with patched frameworks
          echo "ðŸ”„ Pass 2: Building with patched frameworks..."
          flutter build ios --simulator --debug --no-codesign
    artifacts:
      - build/ios/iphonesimulator/Runner.app
    publishing:
      email:
        recipients:
          - polashdas5322@gmail.com

  android-app-preview:
    name: Android App Preview
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      flutter: stable
    scripts:
      - name: Hard Reset and Build APK
        script: |
          # 1. Clean Flutter
          flutter clean
          flutter pub get
          
          # 2. Build APK
          flutter build apk --debug
    artifacts:
      - build/app/outputs/flutter-apk/app-debug.apk
    publishing:
      email:
        recipients:
          - polashdas5322@gmail.com
